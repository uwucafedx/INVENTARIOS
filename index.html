<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro</title>
    <style>
        :root { --p-violet: #b35bd6; --bg-glass: rgba(30, 30, 30, 0.85); --p-light: #e0b3ff; --error-red: #ff3333; --vacio-blue: #3399ff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000 url('Dise%C3%B1o%20sin%20t%C3%ADtulo%20(12).png') no-repeat center center fixed; background-size: cover; display: flex; flex-direction: column; align-items: center; padding: 5px; margin: 0; min-height: 100vh; }
        
        .top-container { display: flex; width: 95%; max-width: 800px; justify-content: space-between; align-items: flex-start; margin-top: 10px; position: relative; height: 120px; }
        h1 { color: #ffffff; letter-spacing: 2px; text-transform: uppercase; text-shadow: 2px 2px 10px var(--p-violet); margin: 0; font-size: 1.5em; flex: 1; }

        .notes-section { 
            width: 130px; height: 130px; 
            background: url('nota1.png') no-repeat center; 
            background-size: contain; 
            display: flex; justify-content: center; align-items: center;
            position: absolute; right: 0; top: -10px; z-index: 10;
        }
        .note-area {
            width: 80%; height: 60%; background: transparent; border: none; 
            color: #4a3728; font-family: 'Segoe UI', sans-serif; font-size: 0.75em; 
            outline: none; resize: none; text-align: center; font-weight: bold; overflow: hidden;
        }

        .user-box { 
            margin: 5px 0 15px 0; font-weight: bold; color: #fff; 
            background: rgba(40, 40, 40, 0.8); padding: 8px 15px; 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); 
            display: flex; align-items: center; gap: 10px;
        }
        select { padding: 5px; border-radius: 8px; border: 2px solid white; font-weight: bold; cursor: pointer; }

        .inventory-card { background: var(--bg-glass); color: white; padding: 15px; border-radius: 20px; width: 95%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: none; backdrop-filter: blur(4px); margin-bottom: 20px; position: relative; }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 5px; }
        .prod-info { flex: 1; }
        .prod-name { font-size: 0.8em; font-weight: bold; text-transform: uppercase; }
        .mod-time { font-size: 0.65em; font-style: italic; opacity: 0.8; }
        .qty-box { min-width: 35px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 0.8em; margin-right: 5px; }

        .input-group { display: flex; align-items: center; gap: 4px; }
        .sign-btn { width: 30px; height: 30px; border: none; border-radius: 6px; color: white; font-weight: bold; font-size: 1.1em; cursor: pointer; }
        .vacio-btn { background: var(--vacio-blue); color: white; border: none; padding: 5px 8px; border-radius: 6px; font-size: 0.65em; font-weight: bold; cursor: pointer; }

        input[type="number"] { padding: 5px; border-radius: 6px; border: none; width: 40px; text-align: center; font-weight: bold; }

        .section-title { text-align: center; color: var(--p-light); font-weight: bold; font-size: 0.75em; margin: 15px 0 8px 0; text-transform: uppercase; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; }

        .save-container-mini {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
            margin-bottom: 15px;
            padding-right: 10px;
        }
        .btn-save-mini { 
            background: var(--p-violet); color: white; border: none; 
            padding: 8px 18px; border-radius: 10px; cursor: pointer; 
            font-size: 1.2em; box-shadow: 0 4px 8px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .btn-save-mini:active { transform: scale(0.95); }

        .btn-save-full { background: var(--p-violet); color: white; border: none; padding: 12px; border-radius: 15px; cursor: pointer; font-size: 1.3em; width: 95%; max-width: 550px; margin-bottom: 40px; font-weight: bold; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; color: white; font-weight: bold; }
    </style>
</head>
<body onload="updateUserUI()">

    <div id="loading-overlay">Cargando tus datos üëçüèª...</div>

    <div class="top-container">
        <h1>INVENTARIO</h1>
        <div class="notes-section">
            <textarea id="notaGeneral" class="note-area" placeholder="Notas..."></textarea>
        </div>
    </div>

    <div class="user-box">
        USUARIO: 
        <select id="userSelect" onchange="updateUserUI();">
            <option value="GIULY" style="background-color: #b4849f; color: white;">GIULY</option>
            <option value="ALEX" style="background-color: #a7a7df; color: white;">ALEX</option>
            <option value="NASHIRA" style="background-color: #6e4792; color: white;">NASHIRA</option>
        </select>
    </div>

    <div class="inventory-card" id="mainCard">
        <div id="listContainer"></div>
        
        <div class="save-container-mini">
            <button id="btnSaveTop" class="btn-save-mini" onclick="saveAllChanges()">üíæ</button>
        </div>

        <div class="section-title">‚ú® Cortes Especiales y Otros</div>
        <div id="extraContainer"></div>
    </div>

    <button id="btnSaveBottom" class="btn-save-full" onclick="saveAllChanges()">üíæ</button>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwsO41veRFVbzPLycyBRC17lynjy_DzEwzyusDr2UWQvryFCn7ISwRg6HmIBLvkUqTHsA/exec'; 
        let inventoryData = [];
        const userColors = { "GIULY": "#b4849f", "ALEX": "#a7a7df", "NASHIRA": "#6e4792" };
        
        // LISTA DE PRODUCTOS QUE VAN EN "Cortes Especiales y Otros"
        const extraItems = [
            "jamon rebanado", "jam√≥n rebanado", "lomo de ternera", "solomillo de res", 
            "jamon cortado en cubos", "jamon cortado", "bolonia en rodajas", "medallon de carne", "medallon de carne",
            "fideos fetuccine", "masa", "jugo de naranja", "naranja",
            "jugo de pi√±a", "pi√±a", "jugo de fresa", "fresa", "jugo de manzana", "manzana"
        ];

        // EMOJIS ACTUALIZADOS
        const emojis = { 
            "carne de venado": "ü¶å", "losa de carne": "ü•©", "jamon": "üçñ", "bolonias": "ü•™",
            "jamon rebanado": "ü•ì", "jam√≥n rebanado": "ü•ì", "lomo de ternera": "ü•©", "solomillo de res": "ü•©", 
            "jamon cortado en cubos": "üçñ", "jamon cortado": "üçñ", "bolonia en rodajas": "üç•", "medallon de carne": "ü•©",
            "fideos fetuccine": "üçù", "masa": "üçú", 
            "naranja": "üçä", "jugo de naranja": "üçä", 
            "pi√±a": "üçç", "jugo de pi√±a": "üçç", 
            "fresa": "üçì", "jugo de fresa": "üçì", 
            "manzana": "üçé", "jugo de manzana": "üçé",
            "aguas carbonatadas": "ü•§"
        };

        function timeSince(dateStr) {
            if (!dateStr || dateStr === '-' || dateStr === '---') return 'Sin registros';
            try {
                const dateObj = new Date(String(dateStr).replace('T', ' ').replace('Z', ''));
                if (isNaN(dateObj.getTime())) return 'Sin registros';
                const diff = Math.floor((new Date() - dateObj) / 60000);
                if (diff < 1) return 'Reci√©n ahora';
                if (diff < 60) return `Hace ${diff} min`;
                if (diff < 1440) return `Hace ${Math.floor(diff/60)} h`;
                return `Hace ${Math.floor(diff/1440)} d`;
            } catch(e) { return 'Sin registros'; }
        }

        function toggleSign(btn) {
            const user = document.getElementById('userSelect').value;
            if (btn.innerText === "+") {
                btn.innerText = "-";
                btn.style.backgroundColor = "var(--error-red)";
            } else {
                btn.innerText = "+";
                btn.style.backgroundColor = userColors[user];
            }
        }

        function setVacio(btn, stockActual) {
            const row = btn.closest('.row');
            const input = row.querySelector('.qty-input');
            const signBtn = row.querySelector('.sign-btn');
            input.value = stockActual;
            signBtn.innerText = "-";
            signBtn.style.backgroundColor = "var(--error-red)";
        }

        function updateUserUI() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            document.getElementById('userSelect').style.backgroundColor = color;
            document.getElementById('btnSaveTop').style.backgroundColor = color;
            document.getElementById('btnSaveBottom').style.backgroundColor = color;
            renderInventory();
        }

        async function loadFromSheet() {
            try {
                const resp = await fetch(WEB_APP_URL);
                inventoryData = await resp.json();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('mainCard').style.display = 'block';
                renderInventory();
            } catch (e) { document.getElementById('loading-overlay').innerText = "‚ö†Ô∏è Error"; }
        }

        function renderInventory() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            const cont = document.getElementById('listContainer');
            const extCont = document.getElementById('extraContainer');
            cont.innerHTML = ''; extCont.innerHTML = '';
            const colIdx = (user === "GIULY") ? 1 : (user === "ALEX") ? 3 : 5;
            
            inventoryData.forEach((row, i) => {
                if (i < 2 || !row[0]) return;
                const name = row[0].trim();
                if (name.toLowerCase() === "nota") {
                    document.getElementById('notaGeneral').value = row[colIdx] || "";
                    return;
                }
                const stock = row[colIdx] || 0;
                const emoji = emojis[name.toLowerCase()] || "üì¶";
                const html = `
                    <div class="row">
                        <div class="prod-info">
                            <div class="prod-name">${emoji} ${name}</div>
                            <div class="mod-time" style="color:${color}">Modificado: ${timeSince(row[colIdx+1])}</div>
                        </div>
                        <div class="qty-box" style="background-color:${color}">${stock}</div>
                        <div class="input-group">
                            <button class="vacio-btn" onclick="setVacio(this, ${stock})">üóëÔ∏è VACIO</button>
                            <button class="sign-btn" style="background-color:${color}" onclick="toggleSign(this)">+</button>
                            <input type="number" class="qty-input" data-prod="${name}" data-col="${colIdx}" placeholder="0" inputmode="numeric">
                        </div>
                    </div>`;
                if (extraItems.includes(name.toLowerCase())) extCont.innerHTML += html;
                else cont.innerHTML += html;
            });
        }

        async function saveAllChanges() {
            const inputs = document.querySelectorAll('.qty-input');
            const nota = document.getElementById('notaGeneral').value;
            if (inputs.length === 0) return;
            const userCol = parseInt(inputs[0].getAttribute('data-col'));
            let updates = [];

            inputs.forEach(input => {
                let val = parseInt(input.value);
                if (!isNaN(val) && val !== 0) {
                    if (input.previousElementSibling.innerText === "-") val = -Math.abs(val);
                    updates.push({ producto: input.getAttribute('data-prod'), cantidad: val, userCol: userCol });
                }
            });
            updates.push({ producto: "nota", cantidad: nota, userCol: userCol });

            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').innerText = "Guardando...";
            for (let up of updates) { 
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(up) }); 
            }
            location.reload();
        }
        loadFromSheet();
    </script>
</body>
</html>
