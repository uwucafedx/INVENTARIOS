<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro</title>
    <style>
        :root { --p-violet: #b35bd6; --bg-glass: rgba(30, 30, 30, 0.85); --p-light: #e0b3ff; --error-red: #ff3333; --vacio-blue: #3399ff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000 url('Dise%C3%B1o%20sin%20t%C3%ADtulo%20(12).png') no-repeat center center fixed; background-size: cover; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; min-height: 100vh; }
        
        .top-container { display: flex; width: 95%; max-width: 800px; justify-content: space-between; align-items: flex-start; margin-top: 20px; position: relative; }
        h1 { color: #ffffff; letter-spacing: 3px; text-transform: uppercase; text-shadow: 2px 2px 10px var(--p-violet); margin: 0; flex: 1; text-align: center; }

        .notes-section { 
            width: 150px; height: 150px; 
            background: url('nota1.png') no-repeat center; 
            background-size: contain; 
            display: flex; justify-content: center; align-items: center;
            position: absolute; right: 0; top: -10px;
        }
        .note-area {
            width: 80%; height: 60%; background: transparent; border: none; 
            color: #4a3728; font-family: 'Segoe UI', sans-serif; font-size: 0.85em; 
            outline: none; resize: none; text-align: center; font-weight: bold;
        }

        .user-box { margin: 20px 0; font-weight: bold; color: #fff; background: rgba(40, 40, 40, 0.8); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); }
        select { padding: 8px; border-radius: 8px; border: 2px solid white; font-weight: bold; }

        .inventory-card { background: var(--bg-glass); color: white; padding: 20px; border-radius: 20px; width: 95%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); display: none; backdrop-filter: blur(4px); }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 8px; }
        .prod-info { flex: 1; }
        .prod-name { font-size: 0.85em; font-weight: bold; text-transform: uppercase; }
        .mod-time { font-size: 0.7em; font-style: italic; opacity: 0.8; }
        .qty-box { min-width: 40px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; font-size: 0.85em; margin-right: 5px; }

        .input-group { display: flex; align-items: center; gap: 4px; }
        .sign-btn { width: 32px; height: 32px; border: none; border-radius: 6px; color: white; font-weight: bold; font-size: 1.2em; cursor: pointer; }
        
        /* BOT√ìN VACIO ACTUALIZADO */
        .vacio-btn { background: var(--vacio-blue); color: white; border: none; padding: 6px 10px; border-radius: 8px; font-size: 0.7em; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 3px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .vacio-btn:active { transform: scale(0.9); }

        input[type="number"] { padding: 6px; border-radius: 6px; border: none; width: 45px; text-align: center; font-weight: bold; }

        .section-title { text-align: center; color: var(--p-light); font-weight: bold; font-size: 0.8em; margin: 20px 0 10px 0; text-transform: uppercase; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .btn-save-all { color: white; border: none; padding: 15px; border-radius: 15px; cursor: pointer; font-size: 1.8em; width: 95%; max-width: 550px; margin: 20px 0 40px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; color: white; font-weight: bold; }
    </style>
</head>
<body onload="updateUserUI()">

    <div id="loading-overlay">Cargando üêªüå∏üíÄ...</div>

    <div class="top-container">
        <h1>Inventario</h1>
        <div class="notes-section">
            <textarea id="notaGeneral" class="note-area" placeholder="Notas..."></textarea>
        </div>
    </div>

    <div class="user-box">
        USUARIO: 
        <select id="userSelect" onchange="updateUserUI();">
            <option value="GIULY" style="background-color: #b4849f; color: white;">GIULY</option>
            <option value="ALEX" style="background-color: #a7a7df; color: white;">ALEX</option>
            <option value="NASHIRA" style="background-color: #6e4792; color: white;">NASHIRA</option>
        </select>
    </div>

    <div class="inventory-card" id="mainCard">
        <div id="listContainer"></div>
        <div class="section-title">‚ú® Cortes Especiales y Otros</div>
        <div id="extraContainer"></div>
    </div>

    <button id="btnSave" class="btn-save-all" onclick="saveAllChanges()">üíæ</button>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwsO41veRFVbzPLycyBRC17lynjy_DzEwzyusDr2UWQvryFCn7ISwRg6HmIBLvkUqTHsA/exec'; 
        let inventoryData = [];
        const userColors = { "GIULY": "#b4849f", "ALEX": "#a7a7df", "NASHIRA": "#6e4792" };
        const extraItems = ["medallones de carne", "jam√≥n rebanado", "lomo de ternera", "solomillo de res", "masa", "jugo de fresa", "jugo de naranja", "jugo de pi√±a", "jugo de manzana"];
        const emojis = { "masa": "üçú", "carne de venado": "ü¶å", "losa de carne": "ü•©", "jamon": "üçñ", "bolonias": "ü•™", "aguas carbonatadas": "ü•§", "naranja": "üçä", "pi√±a": "üçç", "fresa": "üçì", "manzana": "üçé", "medallones de carne": "üçî", "jam√≥n rebanado": "üçñ", "lomo de ternera": "ü•©", "solomillo de res": "ü•©", "jugo de fresa": "üçì", "jugo de naranja": "üçä", "jugo de pi√±a": "üçç", "jugo de manzana": "üçé" };

        function timeSince(dateStr) {
            if (!dateStr || dateStr === '-' || dateStr === '---') return 'Sin registros';
            try {
                const dateObj = new Date(String(dateStr).replace('T', ' ').replace('Z', ''));
                if (isNaN(dateObj.getTime())) return 'Sin registros';
                const diff = Math.floor((new Date() - dateObj) / 60000);
                if (diff < 1) return 'Reci√©n ahora';
                if (diff < 60) return `Hace ${diff} min`;
                if (diff < 1440) return `Hace ${Math.floor(diff/60)} h`;
                return `Hace ${Math.floor(diff/1440)} d`;
            } catch(e) { return 'Sin registros'; }
        }

        function toggleSign(btn) {
            const user = document.getElementById('userSelect').value;
            if (btn.innerText === "+") {
                btn.innerText = "-";
                btn.style.backgroundColor = "var(--error-red)";
            } else {
                btn.innerText = "+";
                btn.style.backgroundColor = userColors[user];
            }
        }

        function setVacio(btn, stockActual) {
            const row = btn.closest('.row');
            const input = row.querySelector('.qty-input');
            const signBtn = row.querySelector('.sign-btn');
            input.value = stockActual;
            signBtn.innerText = "-";
            signBtn.style.backgroundColor = "var(--error-red)";
        }

        function updateUserUI() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            document.getElementById('userSelect').style.backgroundColor = color;
            document.getElementById('btnSave').style.backgroundColor = color;
            renderInventory();
        }

        async function loadFromSheet() {
            try {
                const resp = await fetch(WEB_APP_URL);
                inventoryData = await resp.json();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('mainCard').style.display = 'block';
                renderInventory();
            } catch (e) { document.getElementById('loading-overlay').innerText = "‚ö†Ô∏è Error"; }
        }

        function renderInventory() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            const cont = document.getElementById('listContainer');
            const extCont = document.getElementById('extraContainer');
            cont.innerHTML = ''; extCont.innerHTML = '';
            
            const colIdx = (user === "GIULY") ? 1 : (user === "ALEX") ? 3 : 5;
            
            inventoryData.forEach((row, i) => {
                if (i < 2 || !row[0]) return;
                const name = row[0].trim();
                if (name.toLowerCase() === "nota") {
                    document.getElementById('notaGeneral').value = row[colIdx] || "";
                    return;
                }
                const stock = row[colIdx] || 0;
                const emoji = emojis[name.toLowerCase()] || "üì¶";
                const html = `
                    <div class="row">
                        <div class="prod-info">
                            <div class="prod-name">${emoji} ${name}</div>
                            <div class="mod-time" style="color:${color}">Modificado: ${timeSince(row[colIdx+1])}</div>
                        </div>
                        <div class="qty-box" style="background-color:${color}">${stock}</div>
                        <div class="input-group">
                            <button class="vacio-btn" onclick="setVacio(this, ${stock})">üóëÔ∏è VACIO</button>
                            <button class="sign-btn" style="background-color:${color}" onclick="toggleSign(this)">+</button>
                            <input type="number" class="qty-input" data-prod="${name}" data-col="${colIdx}" placeholder="0" inputmode="numeric">
                        </div>
                    </div>`;
                if (extraItems.includes(name.toLowerCase())) extCont.innerHTML += html;
                else cont.innerHTML += html;
            });
        }

        async function saveAllChanges() {
            const inputs = document.querySelectorAll('.qty-input');
            const nota = document.getElementById('notaGeneral').value;
            if (inputs.length === 0) return;
            const userCol = parseInt(inputs[0].getAttribute('data-col'));
            let updates = [];

            inputs.forEach(input => {
                let val = parseInt(input.value);
                if (!isNaN(val) && val !== 0) {
                    if (input.previousElementSibling.innerText === "-") val = -Math.abs(val);
                    updates.push({ producto: input.getAttribute('data-prod'), cantidad: val, userCol: userCol });
                }
            });
            updates.push({ producto: "nota", cantidad: nota, userCol: userCol });

            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').innerText = "Guardando...";
            for (let up of updates) { 
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(up) }); 
            }
            location.reload();
        }
        loadFromSheet();
    </script>
</body>
</html>
