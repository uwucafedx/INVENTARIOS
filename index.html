<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro</title>
    <style>
        :root { --p-violet: #b35bd6; --bg-glass: rgba(30, 30, 30, 0.85); --p-light: #e0b3ff; }
        body { font-family: 'Segoe UI', sans-serif; background: #000 url('Dise%C3%B1o%20sin%20t%C3%ADtulo%20(12).png') no-repeat center center fixed; background-size: cover; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; min-height: 100vh; }
        h1 { color: #ffffff; letter-spacing: 3px; text-transform: uppercase; margin-top: 20px; text-shadow: 2px 2px 10px var(--p-violet); }
        .user-box { margin-bottom: 20px; font-weight: bold; color: #fff; background: rgba(40, 40, 40, 0.8); padding: 12px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; gap: 10px; }
        select { padding: 10px; border-radius: 8px; border: 2px solid white; font-weight: bold; cursor: pointer; outline: none; }
        .inventory-card { background: var(--bg-glass); color: white; padding: 20px; border-radius: 20px; width: 95%; max-width: 550px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-bottom: 20px; backdrop-filter: blur(4px); border: 1px solid rgba(255, 255, 255, 0.1); display: none; }
        .section-title { text-align: center; color: var(--p-light); font-weight: bold; text-transform: uppercase; font-size: 0.9em; margin: 25px 0 15px 0; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px; letter-spacing: 1px; }
        .header-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; border-bottom: 2px solid var(--p-violet); padding-bottom: 10px; }
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; gap: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 10px; }
        .prod-info { flex: 1.2; min-width: 0; }
        .prod-name { font-size: 0.9em; font-weight: bold; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mod-time { font-size: 0.75em; font-style: italic; margin-top: 2px; opacity: 0.9; }
        .qty-box { min-width: 45px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-weight: bold; color: white; font-size: 0.9em; }
        .input-group { display: flex; align-items: center; gap: 4px; }
        .sign-btn { width: 35px; height: 35px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 1.2em; cursor: pointer; }
        input[type="number"] { padding: 8px; border-radius: 8px; border: none; font-weight: bold; width: 50px; text-align: center; font-size: 1em; }
        .btn-save-all { color: white; border: none; padding: 18px; border-radius: 15px; cursor: pointer; font-weight: bold; font-size: 1.1em; width: 95%; max-width: 550px; margin-bottom: 40px; text-transform: uppercase; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; font-weight: bold; }
    </style>
</head>
<body onload="updateUserUI()">

    <div id="loading-overlay">Cargando datosüêªüå∏üíÄ...no te estresesüíï</div>

    <h1>Inventario</h1>

    <div class="user-box">
        USUARIO: 
        <select id="userSelect" onchange="updateUserUI();">
            <option value="GIULY" style="background-color: #b4849f; color: white;">GIULY</option>
            <option value="ALEX" style="background-color: #a7a7df; color: white;">ALEX</option>
            <option value="NASHIRA" style="background-color: #6e4792; color: white;">NASHIRA</option>
        </select>
    </div>

    <div class="inventory-card" id="mainCard">
        <div class="header-row">
            <span>PRODUCTO</span>
            <span>STOCK</span>
            <span>CARGAR</span>
        </div>
        
        <div id="listContainer"></div>

        <div class="section-title">‚ú® Cortes Especiales y Otros</div>
        <div id="extraContainer"></div>
    </div>

    <button id="btnSave" class="btn-save-all" onclick="saveAllChanges()">üíæ GUARDAR CAMBIOS</button>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwsO41veRFVbzPLycyBRC17lynjy_DzEwzyusDr2UWQvryFCn7ISwRg6HmIBLvkUqTHsA/exec'; 
        let inventoryData = [];
        const userColors = { "GIULY": "#b4849f", "ALEX": "#a7a7df", "NASHIRA": "#6e4792" };

        const extraItems = [
            "Medallones de Carne", "Jam√≥n rebanado", "Lomo de ternera", 
            "Solomillo de Res", "Masa", "jugo de fresa", 
            "jugo de naranja", "jugo de pi√±a", "jugo de manzana"
        ];

        const emojis = {
            "carne de venado": "ü¶å", "losa de carne": "ü•©", "jamon": "üçñ", "bolonias": "ü•™",
            "aguas carbonatadas": "ü•§", "naranja": "üçä", "pi√±a": "üçç", "fresa": "üçì", "manzana": "üçé",
            "medallones de carne": "üçî", "jam√≥n rebanado": "üçñ", "lomo de ternera": "ü•©", 
            "solomillo de res": "ü•©", "masa": "üçú", "jugo de manzana": "üçé", 
            "jugo de pi√±a": "üçç", "jugo de fresa": "üçì", "jugo de naranja": "üçä"
        };

        function timeSince(dateString) {
            if (!dateString || dateString.length < 5 || dateString.includes("-")) return "Sin registros";
            
            // Limpia cualquier car√°cter que no sea n√∫mero o separador com√∫n
            const p = dateString.split(/[^0-9]/).filter(n => n !== "");
            if (p.length < 3) return "Sin registros";

            // Crea la fecha del registro (D√≠a, Mes-1, A√±o, Horas, Mins, Segs)
            const recordDate = new Date(p[2], p[1]-1, p[0], p[3]||0, p[4]||0, p[5]||0);
            const diffMs = new Date() - recordDate;
            const diffSec = Math.floor(diffMs / 1000);

            if (isNaN(diffSec) || diffSec < 0) return "Hace unos segundos";
            if (diffSec < 60) return `Hace ${diffSec} seg`;
            
            const diffMin = Math.floor(diffSec / 60);
            if (diffMin < 60) return `Hace ${diffMin} min`;
            
            const diffHrs = Math.floor(diffMin / 60);
            if (diffHrs < 24) return `Hace ${diffHrs} h`;
            
            return `Hace ${Math.floor(diffHrs/24)} d`;
        }

        function toggleSign(btn) {
            btn.innerText = (btn.innerText === "+") ? "-" : "+";
            btn.style.filter = (btn.innerText === "-") ? "brightness(0.7)" : "brightness(1.2)";
        }

        function updateUserUI() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            document.getElementById('userSelect').style.backgroundColor = color;
            document.getElementById('btnSave').style.backgroundColor = color;
            renderInventory();
        }

        async function loadFromSheet() {
            try {
                const response = await fetch(WEB_APP_URL);
                inventoryData = await response.json();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('mainCard').style.display = 'block';
                renderInventory();
            } catch (e) { document.getElementById('loading-overlay').innerHTML = "‚ö†Ô∏è Error de conexi√≥n"; }
        }

        function renderInventory() {
            const user = document.getElementById('userSelect').value;
            const color = userColors[user];
            const container = document.getElementById('listContainer');
            const extraContainer = document.getElementById('extraContainer');
            
            container.innerHTML = '';
            extraContainer.innerHTML = '';
            
            const colIdx = (user === "GIULY") ? 1 : (user === "ALEX") ? 3 : 5;
            const dateIdx = colIdx + 1;
            
            inventoryData.forEach((row, i) => {
                if (i < 2 || !row[0] || row[0].toLowerCase() === "producto" || row[0].toLowerCase() === "nota") return;
                
                const prodName = row[0].trim();
                const isExtra = extraItems.some(e => e.toLowerCase() === prodName.toLowerCase());
                const html = createRowHtml(prodName, row[colIdx], row[dateIdx], colIdx, color);
                
                if (isExtra) extraContainer.innerHTML += html;
                else container.innerHTML += html;
            });
        }

        function createRowHtml(name, stock, date, col, color) {
            const emoji = emojis[name.toLowerCase().trim()] || "üì¶";
            return `
                <div class="row">
                    <div class="prod-info">
                        <div class="prod-name">${emoji} ${name}</div>
                        <div class="mod-time" style="color: ${color}" data-date="${date}">Modificado: ${timeSince(date)}</div>
                    </div>
                    <div class="qty-box" style="background-color: ${color}">${stock || 0}</div>
                    <div class="input-group">
                        <button class="sign-btn" style="background-color: ${color}" onclick="toggleSign(this)">+</button>
                        <input type="number" class="qty-input" data-prod="${name}" data-col="${col}" placeholder="0" inputmode="numeric" style="border: 2px solid ${color}">
                    </div>
                </div>`;
        }

        // Refresca los textos de tiempo cada 10 segundos
        setInterval(() => {
            document.querySelectorAll('.mod-time').forEach(el => {
                const rawDate = el.getAttribute('data-date');
                el.innerText = "Modificado: " + timeSince(rawDate);
            });
        }, 10000);

        async function saveAllChanges() {
            const inputs = document.querySelectorAll('.qty-input');
            let updates = [];
            const userCol = parseInt(inputs[0].getAttribute('data-col'));

            inputs.forEach(input => {
                let val = parseInt(input.value);
                if (!isNaN(val) && val !== 0) {
                    const sign = input.previousElementSibling.innerText;
                    if (sign === "-") val = -Math.abs(val);
                    updates.push({ producto: input.getAttribute('data-prod'), cantidad: val, userCol: userCol });
                }
            });

            if (updates.length === 0) return alert("No hay cambios.");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').innerText = "Guardando...";
            
            for (let up of updates) { 
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(up) }); 
            }
            location.reload();
        }

        loadFromSheet();
    </script>
</body>
</html>
